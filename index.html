<!DOCTYPE html>
<html lang="kk">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Psi Test</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
      /* --- НЕГІЗГІ ДИЗАЙН --- */
      :root {
        --primary-color: #4f46e5;
        --primary-hover: #4338ca;
        --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        --card-bg: #ffffff;
        --text-main: #1f2937;
        --text-secondary: #6b7280;
        --input-bg: #f9fafb;
        --input-border: #e5e7eb;
        --success-color: #10b981;
        --error-color: #ef4444;
        --error-bg: #fee2e2;
      }

      /* --- ТҮНГІ РЕЖИМ (DARK MODE) --- */
      body.dark-mode {
        --bg-gradient: linear-gradient(135deg, #111827 0%, #1f2937 100%);
        --card-bg: #1f2937;
        --text-main: #f9fafb;
        --text-secondary: #9ca3af;
        --input-bg: #374151;
        --input-border: #4b5563;
        --error-bg: rgba(239, 68, 68, 0.2);
      }

      body { 
        font-family: 'Inter', sans-serif; 
        background: var(--bg-gradient); 
        margin: 0; padding: 0; 
        color: var(--text-main);
        min-height: 100vh;
        display: flex; align-items: center; justify-content: center;
        transition: background 0.3s ease;
      }

      body.dark-mode h2, body.dark-mode h3, body.dark-mode .question-text { color: #ffffff !important; }

      .container { 
        width: 100%; max-width: 500px; margin: 20px; 
        background: var(--card-bg); padding: 30px; 
        border-radius: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); 
        transition: background 0.3s ease;
        position: relative;
      }

      h2, h3 { text-align: center; color: #111827; font-weight: 700; margin-bottom: 20px; }

      /* Input Styles */
      input[type="text"], input[type="password"], select { 
        width: 100%; padding: 16px; margin-bottom: 20px; 
        border: 2px solid var(--input-border); border-radius: 16px; 
        box-sizing: border-box; font-size: 16px; background: var(--input-bg); 
        color: var(--text-main); transition: 0.3s; font-family: inherit;
      }
      input:focus, select:focus { 
        outline: none; border-color: var(--primary-color); 
        box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
      }
      label { font-weight: 600; font-size: 14px; color: var(--text-secondary); margin-bottom: 8px; display: block; margin-left: 4px; }

      /* Password Toggle */
      .password-wrapper { position: relative; margin-bottom: 20px; }
      .password-wrapper input { margin-bottom: 0; padding-right: 50px; }
      .toggle-icon {
        position: absolute; right: 15px; top: 50%; transform: translateY(-50%);
        cursor: pointer; color: #9ca3af; display: flex; align-items: center; justify-content: center;
      }
      .toggle-icon:hover { color: var(--primary-color); }

      /* Buttons */
      button { 
        width: 100%; padding: 16px; background-color: var(--primary-color); 
        color: white; border: none; border-radius: 16px; 
        font-size: 16px; font-weight: 600; cursor: pointer; 
        transition: all 0.2s; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
      }
      button:active { transform: scale(0.98); }
      button:disabled { background-color: #9ca3af !important; cursor: not-allowed; box-shadow: none; opacity: 0.8; }

      /* Language Tabs */
      .lang-container { opacity: 0.6; pointer-events: none; transition: 0.3s; margin-top: 20px; }
      .lang-container.active { opacity: 1; pointer-events: all; }
      .lang-group { display: flex; gap: 10px; background: #f3f4f6; padding: 5px; border-radius: 14px; }
      body.dark-mode .lang-group { background: #374151; }
      .lang-btn { 
        flex: 1; padding: 10px; border-radius: 10px; text-align: center; 
        font-weight: 600; font-size: 14px; color: var(--text-secondary); 
        cursor: pointer; transition: 0.2s; 
      }
      .lang-btn.selected { background-color: #fff; color: var(--primary-color); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
      body.dark-mode .lang-btn.selected { background-color: #4f46e5; color: white; }

      /* Questions */
      .question-block { 
        animation: fadeIn 0.4s ease; 
        padding: 10px; 
        border-radius: 16px;
        transition: 0.3s;
        border: 2px solid transparent; /* Жиек орынын дайындау */
      }
      .question-text { font-size: 18px; font-weight: 600; margin-bottom: 20px; line-height: 1.5; color: #111827; }

      /* Radio Styles */
      .radio-label { 
        display: flex; align-items: center; padding: 16px; margin: 12px 0; 
        cursor: pointer; border-radius: 16px; background-color: var(--card-bg); 
        border: 2px solid var(--input-border); transition: all 0.2s;
      }
      .radio-label:hover { border-color: #d1d5db; }
      body.dark-mode .radio-label:hover { border-color: #6b7280; background-color: #374151; }
      .radio-label:has(input:checked) { border-color: var(--primary-color); background-color: #eef2ff; }
      body.dark-mode .radio-label:has(input:checked) { background-color: #312e81; border-color: var(--primary-color); }
      .radio-label input:checked + span { color: var(--primary-color); font-weight: 600; }
      body.dark-mode .radio-label input:checked + span { color: #a5b4fc; }
      .radio-label span { color: var(--text-main); }
      .radio-label input { width: 20px; height: 20px; margin-right: 15px; accent-color: var(--primary-color); }

      /* ҚАТЕ ЖАУАП СТИЛІ (Validation Error) */
      .question-block.error {
        border-color: var(--error-color);
        background-color: var(--error-bg);
        animation: shake 0.5s;
      }
      @keyframes shake {
        0% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        50% { transform: translateX(5px); }
        75% { transform: translateX(-5px); }
        100% { transform: translateX(0); }
      }

      /* Result */
      .result-circle {
        width: 160px; height: 160px; background-color: #ecfdf5; border: 10px solid #d1fae5;
        border-radius: 50%; margin: 20px auto; display: flex; flex-direction: column; 
        align-items: center; justify-content: center; animation: popIn 0.6s;
      }
      body.dark-mode .result-circle { background-color: #064e3b; border-color: #065f46; }
      .score-value { font-size: 56px; font-weight: 800; color: #065f46; line-height: 1; }
      body.dark-mode .score-value { color: #34d399; }
      body.dark-mode .result-circle span:first-child { color: #34d399; }

      /* Theme Toggle Btn */
      .theme-toggle-btn {
        position: fixed; top: 20px; right: 20px; background: var(--card-bg);
        border: 2px solid var(--input-border); color: var(--text-secondary);
        width: 45px; height: 45px; border-radius: 50%; display: flex;
        align-items: center; justify-content: center; cursor: pointer;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 1000; padding: 0;
      }
      
      @media screen and (max-width: 600px) {
        .container { margin: 0; border-radius: 0; min-height: 100vh; padding: 20px; box-shadow: none; }
        #start-btn, #submit-btn { position: fixed; bottom: 20px; left: 20px; right: 20px; width: calc(100% - 40px); z-index: 100; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        #test-view { padding-bottom: 80px; }
        .theme-toggle-btn { top: 15px; right: 15px; width: 40px; height: 40px; }
      }
      .hidden { display: none !important; }
      .error-msg { color: var(--error-color); text-align: center; margin-top: 15px; font-size: 14px; }
      #loader { text-align: center; color: var(--text-secondary); margin: 20px 0; font-size: 14px; }
    </style>
  </head>
  <body>

    <button class="theme-toggle-btn" onclick="toggleTheme()" id="theme-btn" title="Ауыстыру">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
    </button>

    <div class="container">
      <div id="loader" class="hidden"> Жүктелуде...</div>

      <div id="login-view">
        <h2>Психологиялық тесттер</h2>
        
        <label>Курс / Сынып:</label>
        <select id="course-select">
            <option value="" disabled selected>Курсты таңдаңыз...</option>
            <option value="1 cours">1-курс</option>
            <option value="2 cours">2-курс</option>
            <option value="3 cours">3-курс</option>
        </select>

        <label>Логин (ID)</label>
        <input type="text" id="login" placeholder="Мысалы: ps001">
        
        <label>Құпия сөз / Пароль</label>
        <div class="password-wrapper">
            <input type="password" id="password" placeholder="••••••">
            <div class="toggle-icon" onclick="togglePassword()">
                <svg id="eye-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
            </div>
        </div>

        <button onclick="doLogin()">Жүйеге кіру / Вход</button>
        <p id="login-error" class="error-msg"></p>
      </div>

      <div id="setup-view" class="hidden">
        <h3>Сәлем / Привет, <span id="user-name" style="color: var(--primary-color);"></span>!</h3>
        <label>Тестті таңдаңыз / Выберите тест: <span style="color:red">*</span></label>
        <select id="test-select" onchange="enableLangSelection()">
          <option value="" disabled selected>Тізімнен таңдаңыз...</option>
        </select>
        <div id="lang-section" class="lang-container">
          <label>Тіл / Язык: <span style="color:red">*</span></label>
          <div class="lang-group">
            <div class="lang-btn" onclick="selectLang('KZ', this)">QAZ</div>
            <div class="lang-btn" onclick="selectLang('RU', this)">RUS</div>
          </div>
        </div>
        <button id="start-btn" onclick="startTest()" disabled style="margin-top: 30px;">Бастау / Начать</button>
      </div>

      <div id="test-view" class="hidden" style="text-align: center;">
        <div id="test-title" style="background: #eef2ff; color: var(--primary-color); padding: 10px 20px; border-radius: 50px; display: inline-block; font-size: 16px; margin-bottom: 30px;">Student Name</div>
        <div id="questions-container" style="text-align: left;"></div>
        <button id="submit-btn" onclick="submitTest()" style="background-color: var(--success-color);">Аяқтау / Завершить</button>
      </div>

      <div id="result-view" class="hidden" style="text-align: center; padding-top: 20px;">
        <h2>Нәтиже / Результат</h2>
        <div class="result-circle">
          <span style="font-size: 14px; color: #065f46; font-weight: 600; margin-top: 10px;">ҰПАЙ / БАЛЛ</span>
          <span id="final-score" class="score-value">0</span>
        </div>
        <p style="color: var(--text-secondary); margin-bottom: 30px; line-height: 1.6;">Тест аяқталды.<br>Нәтиже сақталды.</p>
        <button onclick="location.reload()" style="background-color: #9ca3af; box-shadow: none; color: #fff;">Шығу</button>
      </div>
    </div>

    <script>
      const API_URL = "https://script.google.com/macros/s/AKfycbzkKLruQnUKuemPxU5U6UjWFWO0a8CrCLv8AKNos7SbVXX86eT2TT8BF6AoOrp0azXN-w/exec"; 
      
      var currentUser = {};
      var selectedLang = "";
      var currentTestName = ""; 
      var preloadedQuestions = null; 

      // --- 1. DARK MODE & INIT ---
      const moonIcon = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>';
      const sunIcon = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>';

      function initTheme() {
        const savedTheme = localStorage.getItem('theme');
        const btn = document.getElementById('theme-btn');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-mode');
            btn.innerHTML = sunIcon;
        } else {
            document.body.classList.remove('dark-mode');
            btn.innerHTML = moonIcon;
        }
      }
      function toggleTheme() {
        const btn = document.getElementById('theme-btn');
        document.body.classList.toggle('dark-mode');
        if (document.body.classList.contains('dark-mode')) {
            localStorage.setItem('theme', 'dark');
            btn.innerHTML = sunIcon;
        } else {
            localStorage.setItem('theme', 'light');
            btn.innerHTML = moonIcon;
        }
      }
      window.onload = initTheme;

      // --- 2. HELPERS (PASSWORD TOGGLE ADDED) ---
      
      // ЖАҢАРТЫЛҒАН: Парольді көрсету/жасыру
      function togglePassword() {
        var input = document.getElementById("password");
        var iconDiv = document.querySelector(".toggle-icon");
        
        if (input.type === "password") {
            input.type = "text";
            // Сызылған көз иконкасы
            iconDiv.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>`;
        } else {
            input.type = "password";
            // Ашық көз иконкасы
            iconDiv.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>`;
        }
      }

      function toggleLoader(show) { document.getElementById('loader').classList.toggle('hidden', !show); }

      async function fetchData(params, postBody = null) {
        try {
          let url = API_URL + "?" + new URLSearchParams(params);
          let options = { redirect: "follow" };
          if (postBody) {
            options.method = "POST";
            options.headers = { "Content-Type": "text/plain;charset=utf-8" };
            options.body = JSON.stringify(postBody);
          }
          let response = await fetch(url, options);
          if (!response.ok) throw new Error("Server Error");
          let text = await response.text();
          try { return JSON.parse(text); } catch (e) { throw new Error("JSON Error"); }
        } catch (e) {
          alert("Байланыс қатесі: " + e.message); return null;
        }
      }

      // --- 3. LOGIN & SETUP ---
      async function doLogin() {
        var course = document.getElementById('course-select').value; // Курс
        var log = document.getElementById('login').value;
        var pass = document.getElementById('password').value;

        if (!course) {
             document.getElementById('login-error').innerText = "Курсты таңдаңыз!";
             return;
        }
        if(!log || !pass) {
             document.getElementById('login-error').innerText = "Логин мен парольді енгізіңіз!";
             return;
        }

        toggleLoader(true);
        var res = await fetchData({ 
             action: 'login', 
             course: course, 
             login: log, 
             password: pass 
        });
        toggleLoader(false);
        
        if (res && res.status === 'success') {
          currentUser = res;
          document.getElementById('login-view').classList.add('hidden');
          document.getElementById('setup-view').classList.remove('hidden');
          document.getElementById('user-name').innerText = res.name;
          
          var sel = document.getElementById('test-select');
          sel.innerHTML = '<option value="" disabled selected>Тізімнен таңдаңыз...</option>';
          if (res.tests) {
             res.tests.forEach(t => {
                var opt = document.createElement('option');
                opt.value = t; opt.innerText = t; sel.appendChild(opt);
             });
          }
        } else {
          document.getElementById('login-error').innerText = res ? res.message : "Байланыс қатесі!";
        }
      }

      function enableLangSelection() {
        var testName = document.getElementById('test-select').value;
        document.getElementById('lang-section').classList.toggle('active', !!testName);
      }

      function selectLang(lang, btn) {
        var testName = document.getElementById('test-select').value;
        if (!testName) { alert("Алдымен тестті таңдаңыз!"); return; }

        selectedLang = lang;
        document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        document.getElementById('start-btn').disabled = false;

        preloadedQuestions = null;
        fetchData({ 
            action: 'getQuestions', 
            testName: testName, 
            lang: selectedLang,
            userName: currentUser.name 
        }).then(res => {
            if (res && res.status === 'success') {
                preloadedQuestions = res.questions;
            }
        });
      }

      // --- 4. START TEST (ТҮЗЕТІЛГЕН: Лимит қатесін көрсетеді) ---
      async function startTest() {
        var testName = document.getElementById('test-select').value;
        if (!testName) {
            alert("Қате: Тест таңдалмаған! Тізімнен тестті таңдаңыз.");
            return;
        }
        if (!selectedLang) return;

        currentTestName = testName; 
        toggleLoader(true);

        if (preloadedQuestions) {
             console.log("Кэш қолданылды");
             renderQuestions(preloadedQuestions);
             toggleLoader(false);
             return;
        }

        var res = await fetchData({ 
            action: 'getQuestions', 
            testName: currentTestName, 
            lang: selectedLang,
            userName: currentUser.name 
        });
        
        if (res && res.status === 'success') {
          toggleLoader(false);
          renderQuestions(res.questions);
        } 
        else {
          // ЛИМИТ ТЕКСЕРУ (МАҢЫЗДЫ)
          if (res && res.message && (res.message.includes("Лимит") || res.message.includes("Limit"))) {
              toggleLoader(false);
              alert("⛔ " + res.message); // Қатені көрсету
              return; 
          }

          console.log("Бірінші әрекет сәтсіз, қайта көруде...");
          setTimeout(async function() {
              var retryRes = await fetchData({ 
                  action: 'getQuestions', 
                  testName: currentTestName, 
                  lang: selectedLang,
                  userName: currentUser.name 
              });
              toggleLoader(false);
              
              if (retryRes && retryRes.status === 'success') {
                  renderQuestions(retryRes.questions);
              } else {
                  // Екінші ретте де Лимитті тексереміз
                  if (retryRes && retryRes.message && (retryRes.message.includes("Лимит") || retryRes.message.includes("Limit"))) {
                       alert("⛔ " + retryRes.message);
                  } else {
                       console.log("Сұрақтар табылмады. Хабарлама жасырылды.");
                  }
              }
          }, 2000); 
        }
      }

      function renderQuestions(questions) {
        document.getElementById('setup-view').classList.add('hidden');
        document.getElementById('test-view').classList.remove('hidden');
        document.getElementById('test-title').innerText = currentUser.name;
        
        var container = document.getElementById('questions-container');
        container.innerHTML = "";
        window.scrollTo(0,0);

        questions.forEach((q, index) => {
          var div = document.createElement('div');
          div.className = 'question-block';
          var html = `<div class="question-text">${index + 1}. ${q.question}</div>`;
          if(q.type === 'text') {
            html += `<input type="text" name="q-${q.id}" placeholder="Жауап..." autocomplete="off">`;
          } else {
            q.options.forEach(opt => {
              html += `<label class="radio-label"><input type="radio" name="q-${q.id}" value="${opt}"><span>${opt}</span></label>`;
            });
          }
          div.innerHTML = html;
          container.appendChild(div);
        });
      }

      // --- 5. SUBMIT (VALIDATION & LIMIT) ---
      async function submitTest() {
        var btn = document.getElementById('submit-btn');
        if (btn.disabled) return;

        var questionBlocks = document.querySelectorAll('.question-block');
        var allAnswered = true;
        var firstUnanswered = null;

        questionBlocks.forEach(block => {
            var textInput = block.querySelector('input[type=text]');
            var radios = block.querySelectorAll('input[type=radio]');
            var isAnswered = false;

            if (textInput) { if (textInput.value.trim() !== "") isAnswered = true; } 
            else if (radios.length > 0) { radios.forEach(r => { if (r.checked) isAnswered = true; }); }

            if (!isAnswered) {
                allAnswered = false;
                block.classList.add('error');
                if (!firstUnanswered) firstUnanswered = block; 
            } else {
                block.classList.remove('error');
            }
        });

        if (!allAnswered) {
            alert("Барлық сұрақтарға жауап беру міндетті!");
            if (firstUnanswered) firstUnanswered.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return; 
        }

        if(!confirm("Аяқтауға сенімдісіз бе?")) return;
        
        var answers = {};
        document.querySelectorAll('input[type=text], input[type=radio]:checked').forEach(inp => {
          answers[inp.name.replace('q-', '')] = inp.value;
        });

        btn.disabled = true;
        btn.innerText = "Жіберілуде...";
        toggleLoader(true);

        var res = await fetchData({ action: 'submit' }, {
            userInfo: currentUser,
            testName: currentTestName,
            answers: answers
        });
        
        toggleLoader(false);

        if (res && res.status === 'success') {
          document.getElementById('test-view').classList.add('hidden');
          document.getElementById('result-view').classList.remove('hidden');
          document.getElementById('final-score').innerText = res.score;
        } else {
          alert("ҚАТЕ: " + (res ? res.message : "Сервер жауап бермеді"));
          if (res && res.message && res.message.includes("Лимит")) {
             btn.innerText = "Тапсырылған";
          } else {
             btn.disabled = false;
             btn.innerText = "Аяқтау";
          }
        }
      }
    </script>
  </body>
</html>
